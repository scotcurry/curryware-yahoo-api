FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /app

# Get the solution and all of the projects copied to the image for build
COPY *.sln ./
COPY curryware-fantasy-command-line-tool/curryware-fantasy-command-line-tool.csproj curryware-fantasy-command-line-tool/
COPY curryware-kafka-producer-library/curryware-kafka-producer-library.csproj curryware-kafka-producer-library/
COPY curryware-log-handler/curryware-log-handler.csproj curryware-log-handler/
COPY curryware-yahoo-api/curryware-yahoo-api.csproj curryware-yahoo-api/
COPY curryware-yahoo-api-tests/curryware-yahoo-api-tests.csproj curryware-yahoo-api-tests/
COPY curryware-yahoo-parsing-library/curryware-yahoo-parsing-library.csproj curryware-yahoo-parsing-library/

# Find and download all of the dependencies.
RUN dotnet restore
COPY . ./

# Build both the API project and the command line project to different folders
RUN dotnet publish curryware-yahoo-api/curryware-yahoo-api.csproj -c Release -o /app/publish /p:UseAppHost=false
RUN dotnet publish curryware-fantasy-command-line-tool/curryware-fantasy-command-line-tool.csproj -o /app/publish/command-line

# Get a new "cleaner" image to run the application
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS runtime
WORKDIR /app
EXPOSE 8087
ENV ASPNETCORE_HTTP_PORTS=8087
# This should enable Continuous Profiler
ENV CORECLR_ENABLE_PROFILING=1
ENV CORECLR_PROFILER={846F5F1C-F9AE-4B07-969E-05C26BC060D8}
ENV CORECLR_PROFILER_PATH=/opt/datadog/Datadog.Trace.ClrProfiler.Native.so
ENV DD_DOTNET_TRACER_HOME=/opt/datadog
ENV LD_PRELOAD=/opt/datadog/continuousprofiler/Datadog.Linux.ApiWrapper.x64.so

# Copy the built projects to this image
COPY --from=build /app/publish .
COPY --from=build /app/publish/command-line ./command-line
ENTRYPOINT ["dotnet", "curryware-yahoo-api.dll"]
